<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>المتجر الإلكتروني المتكامل</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #e74c3c;
            --accent-color: #3498db;
        }

        body {
            background-color: #f8f9fa;
            font-family: 'Tajawal', sans-serif;
            min-height: 100vh;
        }

        .product-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid #eee;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            background: white;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.08);
        }

        .badge-offer {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 2;
            background: var(--secondary-color);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
        }

        .quantity-controls {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: #f8f9fa;
            border-radius: 25px;
            padding: 2px 10px;
        }

        .cart-item {
            animation: slideIn 0.3s ease forwards;
            background: #fff;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .search-container {
            position: relative;
            max-width: 500px;
            margin: 0 auto;
        }

        .search-results {
            position: absolute;
            width: 100%;
            z-index: 1000;
            background: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: none;
            max-height: 400px;
            overflow-y: auto;
        }

        .wishlist-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 2;
            background: rgba(255,255,255,0.9);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(50px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .rating-stars {
            color: #ffd700;
            font-size: 0.9em;
        }

        .product-details-modal img {
            max-height: 400px;
            object-fit: contain;
        }

        .currency {
            font-family: Arial, sans-serif;
            margin-right: 2px;
        }
    </style>
</head>
<body>
    <!-- الهيدر المتطور -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-store me-2"></i>متجرنا الإلكتروني
            </a>
            
            <div class="d-flex align-items-center gap-4">
                <div class="search-container">
                    <input type="text" id="searchInput" class="form-control" placeholder="ابحث عن منتج...">
                    <div id="searchResults" class="search-results"></div>
                </div>
                
                <div class="position-relative">
                    <i class="fas fa-heart text-white fs-5" 
                       data-bs-toggle="offcanvas" 
                       data-bs-target="#wishlistOffcanvas"></i>
                    <span id="wishlistBadge" 
                          class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                        0
                    </span>
                </div>

                <div class="position-relative">
                    <i class="fas fa-shopping-cart text-white fs-5" 
                       data-bs-toggle="offcanvas" 
                       data-bs-target="#cartOffcanvas"></i>
                    <span id="cartBadge" 
                          class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                        0
                    </span>
                </div>
            </div>
        </div>
    </nav>

    <!-- المحتوى الرئيسي -->
    <main class="container my-5">
        <!-- فلترة المنتجات -->
        <div class="row mb-4">
            <div class="col-12">
                <div id="filters" class="d-flex flex-wrap gap-3">
                    <button class="btn btn-outline-primary active" data-filter="all">الكل</button>
                    <button class="btn btn-outline-primary" data-filter="price_asc">السعر من الأقل للأعلى</button>
                    <button class="btn btn-outline-primary" data-filter="price_desc">السعر من الأعلى للأقل</button>
                    <div id="dynamicCategories" class="d-flex flex-wrap gap-2"></div>
                </div>
            </div>
        </div>

        <!-- عرض المنتجات -->
        <div class="row g-4" id="productsContainer"></div>
    </main>

    <!-- السلة الجانبية -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="cartOffcanvas">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title">سلة المشتريات</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body">
            <div id="cartItems"></div>
            <div class="cart-summary border-top pt-3 mt-3">
                <div class="d-flex justify-content-between mb-2">
                    <span>المجموع:</span>
                    <span id="subtotal">0.00 <span class="currency">₪</span></span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>الخصم:</span>
                    <span id="discount">0.00 <span class="currency">₪</span></span>
                </div>
                <div class="d-flex justify-content-between fw-bold">
                    <span>الإجمالي:</span>
                    <span id="total">0.00 <span class="currency">₪</span></span>
                </div>
                <button class="btn btn-danger w-100 mt-4" onclick="clearCart()">
                    <i class="fas fa-trash me-2"></i>إفراغ السلة
                </button>
                <button class="btn btn-success w-100 mt-2" onclick="shareOnWhatsApp()">
                    <i class="fab fa-whatsapp me-2"></i>مشاركة عبر واتساب
                </button>
            </div>
        </div>
    </div>

    <!-- المفضلة الجانبية -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="wishlistOffcanvas">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title">قائمة المفضلة</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body">
            <div id="wishlistItems"></div>
        </div>
    </div>

    <!-- تفاصيل المنتج -->
    <div class="modal fade" id="productModal">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-body product-details-modal"></div>
            </div>
        </div>
    </div>

<script>
const store = {
    cart: JSON.parse(localStorage.getItem('store_cart')) || [],
    wishlist: JSON.parse(localStorage.getItem('store_wishlist')) || [],
    products: [],
    categories: new Set(),
    phoneNumber: "+972569813333"
};

// تحميل المنتجات من ملف test.txt
async function loadProducts() {
    try {
        const response = await fetch('test.txt');
        if (!response.ok) throw new Error('Failed to load products');
        const data = await response.text();
        
        store.products = data.split('\n').filter(line => line.trim()).map((line, index) => {
            const parts = line.split('/').map(p => p.trim());
            if (parts.length < 4) throw new Error('Invalid product format');
            
            return {
                id: index + 1,
                company: parts[0],
                name: parts[1],
                price: parseFloat(parts[2].replace(/[^0-9.]/g, '')),
                image: parts.slice(3).join('/').replace(/\/+/g, '/'), // معالجة الروابط المعقدة
                stock: Math.floor(Math.random() * 50) + 10,
                sku: `PROD-${Date.now().toString(36).toUpperCase()}`,
                category: parts[0]
            };
        });
        
        store.products.forEach(p => store.categories.add(p.company));
        initStore();
    } catch (error) {
        console.error('Error:', error);
        showError('حدث خطأ في تحميل المنتجات. يرجى التحقق من ملف البيانات');
    }
}

function saveToStorage() {
    localStorage.setItem('store_cart', JSON.stringify(store.cart));
    localStorage.setItem('store_wishlist', JSON.stringify(store.wishlist));
}

function renderProducts(products = store.products) {
    const container = document.getElementById('productsContainer');
    container.innerHTML = products.map(product => {
        const inCart = store.cart.find(item => item.id === product.id);
        const inWishlist = store.wishlist.includes(product.id);
        
        return `
        <div class="col-md-4 col-lg-3">
            <div class="product-card card h-100">
                ${product.stock < 5 ? `<span class="badge badge-offer">كمية محدودة</span>` : ''}
                
                <button class="wishlist-btn ${inWishlist ? 'text-danger' : 'text-secondary'}" 
                        onclick="toggleWishlist(${product.id})">
                    <i class="fas fa-heart"></i>
                </button>

                <img src="${product.image}" 
                     class="card-img-top" 
                     alt="${product.name}"
                     loading="lazy"
                     style="height: 200px; object-fit: contain;"
                     onerror="this.src='https://via.placeholder.com/300?text=صورة+غير+متوفرة'"
                     data-bs-toggle="modal" 
                     data-bs-target="#productModal"
                     onclick="showProductDetails(${product.id})">

                <div class="card-body">
                    <h6 class="card-title">${product.name}</h6>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted small">${product.company}</span>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="h5 text-primary">${product.price.toFixed(2)} <span class="currency">₪</span></span>
                        ${inCart ? `
                            <div class="quantity-controls">
                                <button class="btn btn-sm btn-outline-secondary" 
                                        onclick="updateCart(${product.id}, -1)">
                                    -
                                </button>
                                <span>${inCart.quantity}</span>
                                <button class="btn btn-sm btn-outline-secondary" 
                                        onclick="updateCart(${product.id}, 1)">
                                    +
                                </button>
                            </div>
                        ` : `
                            <button class="btn btn-primary btn-sm" 
                                    onclick="updateCart(${product.id}, 1)"
                                    ${product.stock < 1 ? 'disabled' : ''}>
                                <i class="fas fa-cart-plus"></i>
                                ${product.stock < 1 ? 'نفذت الكمية' : 'إضافة'}
                            </button>
                        `}
                    </div>
                </div>
            </div>
        </div>
        `;
    }).join('');
}

function updateCart(productId, quantityChange) {
    const product = store.products.find(p => p.id === productId);
    if (!product) return;

    const cartItem = store.cart.find(item => item.id === productId);
    
    if (cartItem) {
        cartItem.quantity += quantityChange;
        if (cartItem.quantity < 1) {
            store.cart = store.cart.filter(item => item.id !== productId);
        }
    } else {
        store.cart.push({...product, quantity: 1});
    }

    product.stock = Math.max(0, product.stock - quantityChange);
    updateUI();
}

function toggleWishlist(productId) {
    const index = store.wishlist.indexOf(productId);
    if (index === -1) {
        store.wishlist.push(productId);
    } else {
        store.wishlist.splice(index, 1);
    }
    updateUI();
}

function updateUI() {
    saveToStorage();
    renderProducts();
    renderCart();
    renderWishlist();
    updateBadges();
    renderCategories();
}

function renderCart() {
    const container = document.getElementById('cartItems');
    container.innerHTML = store.cart.map(item => `
        <div class="cart-item">
            <div class="d-flex align-items-center gap-3">
                <img src="${item.image}" 
                     style="width: 60px; height: 60px; object-fit: contain;" 
                     class="rounded"
                     onerror="this.src='https://via.placeholder.com/60?text=صورة+غير+متوفرة'">
                <div class="flex-grow-1">
                    <h6>${item.name}</h6>
                    <div class="d-flex align-items-center gap-2">
                        <button class="btn btn-sm btn-outline-secondary" 
                                onclick="updateCart(${item.id}, -1)">
                            -
                        </button>
                        <span>${item.quantity}</span>
                        <button class="btn btn-sm btn-outline-secondary" 
                                onclick="updateCart(${item.id}, 1)">
                            +
                        </button>
                        <span class="ms-2">${(item.price * item.quantity).toFixed(2)} <span class="currency">₪</span></span>
                        <button class="btn btn-danger btn-sm ms-auto" 
                                onclick="removeFromCart(${item.id})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');

    const subtotal = store.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    document.getElementById('subtotal').textContent = subtotal.toFixed(2);
    document.getElementById('total').textContent = subtotal.toFixed(2);
}

function removeFromCart(productId) {
    const item = store.cart.find(item => item.id === productId);
    if (item) {
        const product = store.products.find(p => p.id === productId);
        product.stock += item.quantity;
        store.cart = store.cart.filter(i => i.id !== productId);
        updateUI();
    }
}

function clearCart() {
    store.cart.forEach(item => {
        const product = store.products.find(p => p.id === item.id);
        product.stock += item.quantity;
    });
    store.cart = [];
    updateUI();
}

function renderWishlist() {
    const container = document.getElementById('wishlistItems');
    container.innerHTML = Array.from(store.wishlist).map(id => {
        const product = store.products.find(p => p.id === id);
        return product ? `
            <div class="card mb-2">
                <div class="card-body d-flex align-items-center gap-3">
                    <img src="${product.image}" 
                         style="width: 50px; height: 50px; object-fit: contain;">
                    <h6 class="mb-0">${product.name}</h6>
                    <button class="btn btn-danger btn-sm ms-auto" 
                            onclick="toggleWishlist(${product.id})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        ` : '';
    }).join('');
}

function renderCategories() {
    const container = document.getElementById('dynamicCategories');
    container.innerHTML = Array.from(store.categories).map(category => `
        <button class="btn btn-outline-primary" 
                onclick="filterByCategory('${category}')">
            ${category}
        </button>
    `).join('');
}

function filterByCategory(category) {
    const filtered = store.products.filter(p => p.company === category);
    renderProducts(filtered);
}

function shareOnWhatsApp() {
    if (store.cart.length === 0) return showToast('السلة فارغة', 'danger');
    
    const itemsText = store.cart.map(item => 
        `${item.name}%0Aالكمية: ${item.quantity}%0Aالسعر: ${item.price.toFixed(2)} ₪%0Aالمجموع: ${(item.price * item.quantity).toFixed(2)} ₪`
    ).join('%0A------------------------%0A');

    const total = store.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0).toFixed(2);
    
    const message = `*فاتورة شراء من متجرنا*%0A%0A${itemsText}%0A%0A*الإجمالي النهائي:* ${total} ₪%0A%0Aشكراً لاختياركم!`;
    
    window.open(`https://wa.me/${store.phoneNumber}?text=${message}`, '_blank');
}

function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast show position-fixed bottom-0 end-0 m-3 bg-${type} text-white`;
    toast.innerHTML = `
        <div class="d-flex align-items-center p-3">
            <i class="fas fa-${type === 'success' ? 'check' : 'exclamation'}-circle me-2"></i>
            <span>${message}</span>
        </div>
    `;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

function updateBadges() {
    document.getElementById('cartBadge').textContent = store.cart.reduce((sum, item) => sum + item.quantity, 0);
    document.getElementById('wishlistBadge').textContent = store.wishlist.length;
}

function initStore() {
    document.getElementById('searchInput').addEventListener('input', (e) => {
        const results = store.products.filter(p => 
            p.name.toLowerCase().includes(e.target.value.toLowerCase()) ||
            p.company.toLowerCase().includes(e.target.value.toLowerCase())
        );
        renderSearchResults(results);
    });
}

function renderSearchResults(results) {
    const container = document.getElementById('searchResults');
    container.innerHTML = results.slice(0, 5).map(product => `
        <a href="#" class="d-block p-3 border-bottom text-decoration-none text-dark" 
           onclick="showProductDetails(${product.id})">
            <div class="d-flex align-items-center gap-3">
                <img src="${product.image}" 
                     style="width: 40px; height: 40px; object-fit: contain;">
                <div>
                    <h6 class="mb-0">${product.name}</h6>
                    <small class="text-muted">${product.price.toFixed(2)} ₪</small>
                </div>
            </div>
        </a>
    `).join('');
    container.style.display = results.length ? 'block' : 'none';
}

function showProductDetails(productId) {
    const product = store.products.find(p => p.id === productId);
    if (!product) return;
    
    const modalBody = document.querySelector('.product-details-modal');
    modalBody.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <img src="${product.image}" 
                     class="img-fluid rounded-3" 
                     alt="${product.name}"
                     onerror="this.src='https://via.placeholder.com/400?text=صورة+غير+متوفرة'">
            </div>
            <div class="col-md-6">
                <h3>${product.name}</h3>
                <p class="text-muted">${product.company}</p>
                <h4 class="text-primary">${product.price.toFixed(2)} <span class="currency">₪</span></h4>
                <p>الكمية المتاحة: ${product.stock}</p>
                <button class="btn btn-primary btn-lg w-100" 
                        onclick="updateCart(${product.id}, 1)"
                        ${product.stock < 1 ? 'disabled' : ''}>
                    <i class="fas fa-cart-plus me-2"></i>
                    ${product.stock < 1 ? 'نفذت الكمية' : 'إضافة إلى السلة'}
                </button>
            </div>
        </div>
    `;
}

// بدء التحميل
loadProducts();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
