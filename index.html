</head>
<body>
    <header>
        <h1>Online Store</h1>
    </header>
    <main>
        <div id="categories"></div>
    </main>
    <div class="cart" id="cart">
        <h2>Cart</h2>
        <div id="cart-items"></div>
        <button class="share-button" id="checkout-button">Checkout</button>
        <button class="toggle-cart" id="toggle-cart-button">إخفاء السلة</button>
    </div>
    <div class="popup" id="popup">
        <h2>Customer Details</h2>
        <input type="text" id="customer-name" placeholder="Enter your name">
        <input type="text" id="customer-phone" placeholder="Enter your phone number">
        <button id="confirm-button">Confirm</button>
        <button id="cancel-button">Cancel</button>
    </div>

    <script>
const categoriesContainer = document.getElementById('categories');
const cartItemsContainer = document.getElementById('cart-items');
const checkoutButton = document.getElementById('checkout-button');
const popup = document.getElementById('popup');
const confirmButton = document.getElementById('confirm-button');
const cancelButton = document.getElementById('cancel-button');
const toggleCartButton = document.getElementById('toggle-cart-button'); // Added toggle button

const customerNameInput = document.getElementById('customer-name');
const customerPhoneInput = document.getElementById('customer-phone');

let products = [];
let cart = JSON.parse(localStorage.getItem('cart')) || [];

// Load products from test.txt
fetch('test.txt')
    .then(response => response.text())
    .then(data => {
        const lines = data.split('\n');
        lines.forEach(line => {
            const parts = line.split('/');
            if (parts.length >= 4) {
                const imageUrl = parts.slice(3).join('/').trim();
                products.push({
                    category: parts[0].trim(),
                    name: parts[1].trim(),
                    price: parseFloat(parts[2].trim()),
                    image: imageUrl
                });
            }
        });
        renderCategories();
        renderCart();
    })
    .catch(error => console.error('Error loading products:', error));

function renderCategories() {
    categoriesContainer.innerHTML = ''; 
    const categories = [...new Set(products.map(p => p.category))];
    categories.forEach(category => {
        const categoryDiv = document.createElement('div');
        categoryDiv.className = 'category';
        const categoryTitle = document.createElement('h2');
        categoryTitle.textContent = category;
        categoryDiv.appendChild(categoryTitle);

        const categoryProducts = products.filter(p => p.category === category);
        categoryProducts.forEach(product => {
            const productDiv = document.createElement('div');
            productDiv.className = 'product';

            const productImage = document.createElement('img');
            productImage.src = product.image;
            productImage.alt = product.name;

            productImage.onerror = () => {
                productImage.src = 'default-image.jpg'; 
            };

            productDiv.appendChild(productImage);

            const productDetails = document.createElement('div');
            productDetails.innerHTML = `<strong>${product.name}</strong><br>Price: ${product.price.toFixed(2)} $`;
            productDiv.appendChild(productDetails);

            const quantityDiv = document.createElement('div');
            quantityDiv.classList.add('quantity-controls');
            quantityDiv.style.display = 'none';

            const quantityInput = document.createElement('input');
            quantityInput.type = 'number';
            quantityInput.value = 1;
            quantityInput.min = 1;
            quantityInput.style.width = '50px';
            quantityInput.addEventListener('focus', () => quantityInput.select());

            const increaseButton = document.createElement('button');
            increaseButton.textContent = '+';
            increaseButton.onclick = () => updateQuantity(quantityInput, 1);

            const decreaseButton = document.createElement('button');
            decreaseButton.textContent = '-';
            decreaseButton.onclick = () => updateQuantity(quantityInput, -1);

            quantityDiv.appendChild(decreaseButton);
            quantityDiv.appendChild(quantityInput);
            quantityDiv.appendChild(increaseButton);

            const addToCartButton = document.createElement('button');
            addToCartButton.textContent = 'Add to Cart';
            addToCartButton.classList.add('add-to-cart-btn');
            addToCartButton.onclick = () => {
                addToCart(product, quantityInput.value);
                quantityDiv.style.display = 'block';
                addToCartButton.style.display = 'none';
            };
            productDiv.appendChild(addToCartButton);

            const existingProduct = cart.find(item => item.name === product.name);
            if (existingProduct) {
                quantityDiv.style.display = 'block';
                addToCartButton.style.display = 'none';
                quantityInput.value = existingProduct.quantity;
            }

            productDiv.appendChild(quantityDiv);
            categoryDiv.appendChild(productDiv);
        });

        categoriesContainer.appendChild(categoryDiv);
    });
}

function addToCart(product, quantity) {
    quantity = parseInt(quantity);
    const existingProduct = cart.find(item => item.name === product.name);
    if (existingProduct) {
        existingProduct.quantity += quantity;
    } else {
        cart.push({ ...product, quantity });
    }
    saveCart();
    renderCart();
}

function updateQuantity(input, change) {
    let newQuantity = parseInt(input.value) + change;
    if (newQuantity >= 1) {
        input.value = newQuantity;
    }
    const productName = input.closest('.product').querySelector('strong').textContent;
    const product = cart.find(item => item.name === productName);
    if (product) {
        product.quantity = newQuantity;
        if (newQuantity === 0) {
            removeFromCart(productName);
            input.closest('.quantity-controls').style.display = 'none';
            input.closest('.product').querySelector('button').style.display = 'block';
        } else {
            saveCart();
            renderCart();
        }
    }
}

function handleQuantityChange(event) {
    const quantityInput = event.target;
    const newQuantity = parseInt(quantityInput.value);
    if (newQuantity >= 1) {
        const productName = quantityInput.closest('.product').querySelector('strong').textContent;
        const product = cart.find(item => item.name === productName);
        if (product) {
            product.quantity = newQuantity;
            saveCart();
            renderCart();
        }
    } else {
        quantityInput.value = 1;
    }
}

function removeFromCart(productName) {
    cart = cart.filter(item => item.name !== productName);
    saveCart();
    renderCart();
}

function saveCart() {
    localStorage.setItem('cart', JSON.stringify(cart));
}

function renderCart() {
    cartItemsContainer.innerHTML = '';
    let total = 0;

    cart.forEach(item => {
        const cartItemDiv = document.createElement('div');
        cartItemDiv.className = 'cart-item';

        const itemDetails = document.createElement('div');
        itemDetails.innerHTML = `
            <strong>${item.name}</strong><br>
            Price: ${item.price.toFixed(2)} $<br>
            Quantity: <input type="number" value="${item.quantity}" min="1" class="cart-quantity" data-product="${item.name}">
        `;
        cartItemDiv.appendChild(itemDetails);

        const removeButton = document.createElement('button');
        removeButton.textContent = 'X';
        removeButton.onclick = () => removeFromCart(item.name);
        cartItemDiv.appendChild(removeButton);

        total += item.price * item.quantity;
        cartItemsContainer.appendChild(cartItemDiv);
    });

    const totalDiv = document.createElement('div');
    totalDiv.className = 'cart-total';
    totalDiv.innerHTML = `<strong>Total: ${total.toFixed(2)} $</strong>`;
    cartItemsContainer.appendChild(totalDiv);

    document.querySelectorAll('.cart-quantity').forEach(input => {
        input.addEventListener('change', (event) => {
            handleQuantityChange(event);
        });
        input.addEventListener('blur', (event) => {
            handleQuantityChange(event);
        });
        input.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                handleQuantityChange(event);
            }
        });
    });
}

checkoutButton.onclick = () => {
    popup.style.display = 'block';
};

confirmButton.onclick = () => {
    const customerName = customerNameInput.value;
    const customerPhone = customerPhoneInput.value;

    if (!customerName || !customerPhone) {
        alert('الرجاء ادخال الأسم و رقم الهاتف.');
        return;
    }

    const text = `...`; // Your existing receipt generation code

    const whatsappURL = `https://wa.me/972566888825?text=${encodeURIComponent(text)}`;
    window.open(whatsappURL, '_blank');

    cart = [];
    saveCart();
    renderCart();
    popup.style.display = 'none';
};

cancelButton.onclick = () => {
    popup.style.display = 'none';
};

// Toggle Cart visibility functionality
toggleCartButton.onclick = () => {
    const cartElement = document.getElementById('cart');
    if (cartElement.style.display === 'none') {
        cartElement.style.display = 'block';
        toggleCartButton.textContent = 'إخفاء السلة';
    } else {
        cartElement.style.display = 'none';
        toggleCartButton.textContent = 'عرض السلة';
    }
};
</script>
</body>
</html>
