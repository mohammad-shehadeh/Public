<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>المتجر الإلكتروني الذكي</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #e74c3c;
        }

        body {
            background-color: #f8f9fa;
            font-family: 'Tajawal', sans-serif;
        }

        .product-card {
            transition: all 0.3s ease;
            border: 1px solid #ddd;
            border-radius: 15px;
            overflow: hidden;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .category-btn {
            transition: all 0.3s ease;
            border-radius: 25px;
        }

        .cart-item {
            animation: slideIn 0.3s ease forwards;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(50px); }
            to { opacity: 1; transform: translateX(0); }
        }

        #cartBadge {
            transition: all 0.3s ease;
        }

        .whatsapp-btn {
            background-color: #25D366;
            color: white;
            border-radius: 25px;
            padding: 10px 20px;
            transition: all 0.3s ease;
        }

        .whatsapp-btn:hover {
            background-color: #128C7E;
        }
    </style>
</head>
<body>
    <!-- الهيدر -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-store"></i> متجرنا الإلكتروني
            </a>
            <div class="d-flex align-items-center">
                <div class="position-relative me-3">
                    <i class="fas fa-shopping-cart text-white fs-4" 
                       data-bs-toggle="offcanvas" 
                       data-bs-target="#cartOffcanvas"></i>
                    <span id="cartBadge" 
                          class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                        0
                    </span>
                </div>
            </div>
        </div>
    </nav>

    <!-- الفلاتر والتصنيفات -->
    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col-12">
                <div id="categories" class="d-flex flex-wrap gap-2"></div>
            </div>
        </div>

        <!-- عرض المنتجات -->
        <div class="row" id="productsContainer"></div>
    </div>

    <!-- سلة المشتريات (Offcanvas) -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="cartOffcanvas">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title">سلة المشتريات</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body">
            <div id="cartItems" class="mb-3"></div>
            <hr>
            <div class="row mb-2">
                <div class="col-6">المجموع:</div>
                <div class="col-6 text-end" id="subtotal">0.00 ر.س</div>
            </div>
            <div class="row mb-3">
                <div class="col-6">الإجمالي:</div>
                <div class="col-6 text-end fw-bold" id="total">0.00 ر.س</div>
            </div>
            <button class="btn btn-danger w-100 mb-2" onclick="clearCart()">
                <i class="fas fa-trash"></i> إفراغ السلة
            </button>
            <button class="whatsapp-btn w-100" onclick="shareOnWhatsApp()">
                <i class="fab fa-whatsapp"></i> مشاركة عبر واتساب
            </button>
        </div>
    </div>

    <script>
        // بيانات التخزين
        let cart = JSON.parse(localStorage.getItem('store_cart')) || [];
        let products = [];
        let categories = new Set();

        // جلب بيانات المنتجات من الملف
        async function loadProducts() {
            try {
                const response = await fetch('test.txt');
                const data = await response.text();
                const lines = data.split('\n').filter(line => line.trim() !== '');

                products = lines.map(line => {
                    const [company, name, price, image] = line.split('/');
                    return {
                        company: company.trim(),
                        name: name.trim(),
                        price: parseFloat(price.trim()),
                        image: image.trim(),
                        id: Date.now() + Math.random()
                    };
                });

                // استخراج التصنيفات
                products.forEach(p => categories.add(p.company));
                renderCategories();
                renderProducts();
                updateCartBadge();
            } catch (error) {
                console.error('حدث خطأ في جلب البيانات:', error);
                alert('تعذر تحميل المنتجات! تأكد من وجود ملف test.txt');
            }
        }

        // عرض التصنيفات
        function renderCategories() {
            const container = document.getElementById('categories');
            container.innerHTML = `
                <button class="btn btn-primary category-btn active" 
                        data-category="all" 
                        onclick="filterProducts('all')">
                    الكل
                </button>
                ${Array.from(categories).map(category => `
                    <button class="btn btn-outline-primary category-btn" 
                            data-category="${category}" 
                            onclick="filterProducts('${category}')">
                        ${category}
                    </button>
                `).join('')}
            `;
        }

        // تصفية المنتجات
        function filterProducts(category) {
            document.querySelectorAll('.category-btn').forEach(btn => 
                btn.classList.remove('active'));
            document.querySelector(`[data-category="${category}"]`).classList.add('active');
            
            const filtered = category === 'all' 
                ? products 
                : products.filter(p => p.company === category);
            
            renderProducts(filtered);
        }

        // عرض المنتجات
        function renderProducts(productsToShow = products) {
            const container = document.getElementById('productsContainer');
            container.innerHTML = productsToShow.map(product => `
                <div class="col-md-4 mb-4">
                    <div class="product-card card h-100">
                        <img src="${product.image}" 
                             class="card-img-top" 
                             alt="${product.name}"
                             style="height: 250px; object-fit: cover;">
                        <div class="card-body">
                            <h5 class="card-title">${product.name}</h5>
                            <p class="text-muted">${product.company}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="h5 text-primary">${product.price.toFixed(2)} ر.س</span>
                                <button class="btn btn-primary" 
                                        onclick="addToCart('${product.id}')">
                                    <i class="fas fa-cart-plus"></i> إضافة
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // إدارة السلة
        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            const existing = cart.find(item => item.id === productId);

            if (existing) {
                existing.quantity++;
            } else {
                cart.push({...product, quantity: 1});
            }

            updateCart();
            showCartNotification(product.name);
        }

        function updateCart() {
            localStorage.setItem('store_cart', JSON.stringify(cart));
            renderCart();
            updateCartBadge();
        }

        function renderCart() {
            const container = document.getElementById('cartItems');
            container.innerHTML = cart.map((item, index) => `
                <div class="cart-item mb-3 p-2 border-bottom">
                    <div class="d-flex align-items-center gap-3">
                        <img src="${item.image}" 
                             style="width: 60px; height: 60px; object-fit: cover;" 
                             class="rounded">
                        <div class="flex-grow-1">
                            <h6>${item.name}</h6>
                            <div class="d-flex align-items-center gap-2">
                                <button class="btn btn-sm btn-secondary" 
                                        onclick="updateQuantity(${index}, -1)">
                                    -
                                </button>
                                <span>${item.quantity}</span>
                                <button class="btn btn-sm btn-secondary" 
                                        onclick="updateQuantity(${index}, 1)">
                                    +
                                </button>
                                <span class="ms-2">${(item.price * item.quantity).toFixed(2)} ر.س</span>
                                <button class="btn btn-danger btn-sm ms-auto" 
                                        onclick="removeFromCart(${index})">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            document.getElementById('subtotal').textContent = 
                cart.reduce((sum, item) => sum + (item.price * item.quantity), 0).toFixed(2) + ' ر.س';
            
            document.getElementById('total').textContent = 
                cart.reduce((sum, item) => sum + (item.price * item.quantity), 0).toFixed(2) + ' ر.س';
        }

        function updateQuantity(index, delta) {
            cart[index].quantity += delta;
            if (cart[index].quantity < 1) cart.splice(index, 1);
            updateCart();
        }

        function removeFromCart(index) {
            cart.splice(index, 1);
            updateCart();
        }

        function clearCart() {
            cart = [];
            updateCart();
        }

        // إشعار الإضافة للسلة
        function showCartNotification(productName) {
            const notification = document.createElement('div');
            notification.className = 'position-fixed bottom-0 end-0 m-3 p-3 bg-success text-white rounded';
            notification.innerHTML = `
                <i class="fas fa-check-circle"></i>
                تمت إضافة ${productName} إلى السلة
            `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 2000);
        }

        // تحديث عدد العناصر في السلة
        function updateCartBadge() {
            const total = cart.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('cartBadge').textContent = total;
        }

        // مشاركة عبر واتساب
        function shareOnWhatsApp() {
            if (cart.length === 0) return alert('السلة فارغة');
            
            const message = `فاتورة شراء من المتجر:\n\n${
                cart.map(item => 
                    `- ${item.name} (${item.quantity}x): ${(item.price * item.quantity).toFixed(2)} ر.س`
                ).join('\n')
            }\n\nالإجمالي: ${document.getElementById('total').textContent}`;

            const encodedMessage = encodeURIComponent(message);
            window.open(`https://wa.me/?text=${encodedMessage}`, '_blank');
        }

        // بدء التحميل
        loadProducts();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
